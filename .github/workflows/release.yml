name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.0'

    - name: Create Secrets file
      run: |
        cat > Sources/ClaudeUsageTracker/Secrets.swift << EOF
        import Foundation
        enum Secrets {
            static let posthogAPIKey = "${{ secrets.POSTHOG_API_KEY }}"
        }
        EOF

    - name: Build Release
      run: |
        swift build -c release

    - name: Create App Bundle
      run: |
        mkdir -p ClaudeUsageTracker.app/Contents/MacOS
        mkdir -p ClaudeUsageTracker.app/Contents/Resources
        cp .build/release/ClaudeUsageTracker ClaudeUsageTracker.app/Contents/MacOS/
        cp Info.plist ClaudeUsageTracker.app/Contents/
        cp Sources/ClaudeUsageTracker/Resources/AppIcon.icns ClaudeUsageTracker.app/Contents/Resources/
        cp -r .build/release/ClaudeUsageTracker_ClaudeUsageTracker.bundle ClaudeUsageTracker.app/Contents/Resources/
        echo -n "APPL????" > ClaudeUsageTracker.app/Contents/PkgInfo

    - name: Create ZIP
      run: |
        zip -r ClaudeUsageTracker.zip ClaudeUsageTracker.app

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Claude Usage Tracker ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Installation

          1. Download `ClaudeUsageTracker.zip` below
          2. Unzip the file
          3. Move `ClaudeUsageTracker.app` to `/Applications`
          4. Run this command in Terminal to allow the app to open:
             ```
             xattr -cr /Applications/ClaudeUsageTracker.app
             ```
          5. Open the app from Applications

          See [INSTALL.md](INSTALL.md) for detailed instructions.

          ## Requirements
          - macOS 13.0 (Ventura) or later
          - [Claude Code](https://docs.anthropic.com/en/docs/claude-code) CLI
        files: |
          ClaudeUsageTracker.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
