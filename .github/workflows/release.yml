name: Build Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: macos-15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Swift version
      run: swift --version

    - name: Create Secrets file
      run: |
        cat > Sources/ClaudeUsageTracker/Secrets.swift << EOF
        import Foundation
        enum Secrets {
            static let posthogAPIKey = "${{ secrets.POSTHOG_API_KEY }}"
        }
        EOF

    - name: Build Release
      run: swift build -c release

    - name: Verify App Bundle
      run: |
        mkdir -p ClaudeUsageTracker.app/Contents/MacOS
        mkdir -p ClaudeUsageTracker.app/Contents/Resources
        cp .build/release/ClaudeUsageTracker ClaudeUsageTracker.app/Contents/MacOS/
        cp Info.plist ClaudeUsageTracker.app/Contents/
        cp Sources/ClaudeUsageTracker/Resources/AppIcon.icns ClaudeUsageTracker.app/Contents/Resources/
        cp -r .build/release/ClaudeUsageTracker_ClaudeUsageTracker.bundle ClaudeUsageTracker.app/Contents/Resources/
        echo "âœ… Build and bundle verification successful"
